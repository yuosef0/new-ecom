# โ๏ธ ุฅุนุฏุงุฏ Paymob Callbacks - ุงูุฏููู ุงูุตุญูุญ

ุจุนุฏ ูุญุต Paymob Portalุ ุฅููู ุงูุฅุนุฏุงุฏุงุช ุงูุตุญูุญุฉ:

---

## ๐ ูููุน Callback Settings

### โ ุงููููุน ุงูุตุญูุญ: Payment Integrations

**ููุณ ูู iFrames!** โ

Callback URLs ููุฌูุฏุฉ ูู:
```
Developers โ Payment Integrations โ Online Card Integration
```

---

## ๐ง ุฃููุงุน Callbacks ูู Paymob

ููุฌุฏ ููุนุงู ูู Callbacks:

### 1. **Processed Callback** 
**ุงููุตู:** ููุณุชุฏุนู ุจุนุฏ ูุนุงูุฌุฉ ุงูุฏูุน (ูุฌุญ ุฃู ูุดู)

**ูุชู ููุณุชุฎุฏู:** 
- ูุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ููุชุฃูุฏ ูู ุงุณุชูุงู ุฅุดุนุงุฑ ุงูุฏูุน

**ุงูุฑุงุจุท ุงููุทููุจ:**
```
https://yourdomain.com/api/webhooks/paymob
```

**ูู ุงูุชุทููุฑ ุงููุญูู (ูุน ngrok/localtunnel):**
```
https://your-tunnel-url.com/api/webhooks/paymob
```

---

### 2. **Response Callback**
**ุงููุตู:** ููุณุชุฏุนู ูุชุญููู ุงููุณุชุฎุฏู ุจุนุฏ ุงูุฏูุน

**ูุชู ููุณุชุฎุฏู:**
- ูุชุญููู ุงููุณุชุฎุฏู ูุตูุญุฉ ุงูุชุฃููุฏ
- ูุนุฑุถ ูุชูุฌุฉ ุงูุฏูุน ูููุณุชุฎุฏู

**ุงูุฑุงุจุท ุงููุทููุจ:**
```
https://yourdomain.com/api/paymob/callback
```

**ูู ุงูุชุทููุฑ ุงููุญูู (ูุน ngrok/localtunnel):**
```
https://your-tunnel-url.com/api/paymob/callback
```

---

## ๐ ุฎุทูุงุช ุงูุฅุนุฏุงุฏ ูู Paymob Portal

### ุงูุฎุทูุฉ 1: ุชุณุฌูู ุงูุฏุฎูู

ุงุฐูุจ ุฅูู: **https://accept.paymob.com/portal2/en/login**

### ุงูุฎุทูุฉ 2: ุงุฐูุจ ุฅูู Payment Integrations

1. ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉุ ุงุถุบุท ุนูู **"Developers"**
2. ุงุฎุชุฑ **"Payment Integrations"**
3. ุณุชุฌุฏ ูุงุฆูุฉ ุจุงูู integrations

### ุงูุฎุทูุฉ 3: ุงุฎุชุฑ Integration

ุงุจุญุซ ุนู:
- **Integration Type:** Online Card
- **Integration ID:** 4549597 (ุฃู Integration ID ุงูุฎุงุต ุจู)

ุงุถุบุท ุนููู ููุชุนุฏูู

### ุงูุฎุทูุฉ 4: ุฃุถู Callback URLs

ูู ุตูุญุฉ Integration Settingsุ ุณุชุฌุฏ ุญูููู:

#### ุฃ) Processed Callback
```
https://yourdomain.com/api/webhooks/paymob
```

**ุงููุธููุฉ:**
- โ ูุชู ุงุณุชุฏุนุงุคู ูู ุงูุฎูููุฉ (server-to-server)
- โ ูุญุฏุซ ุญุงูุฉ ุงูุทูุจ
- โ ูุฎุตู ุงููุฎุฒูู
- โ ุขูู ููุง ูุนุชูุฏ ุนูู ุงููุณุชุฎุฏู

#### ุจ) Response Callback
```
https://yourdomain.com/api/paymob/callback
```

**ุงููุธููุฉ:**
- โ ูุญูู ุงููุณุชุฎุฏู ุจุนุฏ ุงูุฏูุน
- โ ูุนุฑุถ ุตูุญุฉ ุงูุชุฃููุฏ
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู

### ุงูุฎุทูุฉ 5: ุงุญูุธ ุงูุชุบููุฑุงุช

ุงุถุบุท **"Save"** ุฃู **"Update"**

---

## ๐ฏ ุงููุฑู ุจูู Processed ู Response

| ุงูููุฒุฉ | Processed Callback | Response Callback |
|--------|-------------------|-------------------|
| **ูุชู ููุณุชุฏุนู** | ูู ุงูุฎูููุฉ | ุนูุฏ ุชุญููู ุงููุณุชุฎุฏู |
| **ุงูุงุณุชุฎุฏุงู** | ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช | ุนุฑุถ ุตูุญุฉ ูููุณุชุฎุฏู |
| **ุงูุฃูุงู** | ุนุงูู (server-to-server) | ูุชูุณุท (ููุฑ ุจุงููุณุชุฎุฏู) |
| **ุงูููุซูููุฉ** | ุนุงููุฉ | ุชุนุชูุฏ ุนูู ุงููุณุชุฎุฏู |
| **ุงูุฃููููุฉ** | โญโญโญ ุถุฑูุฑู | โญโญ ููู |

---

## โ ุงูุฅุนุฏุงุฏ ุงูููุตู ุจู

### ููุฅูุชุงุฌ (ุจุนุฏ ุงููุดุฑ ุนูู Vercel):

#### 1. Processed Callback (ุถุฑูุฑู)
```
https://yoursite.vercel.app/api/webhooks/paymob
```

**ุงูุณุจุจ:**
- ูุถูู ุชุญุฏูุซ ุงูุทูุจ ุญุชู ูู ุฃุบูู ุงููุณุชุฎุฏู ุงููุชุตูุญ
- ุขูู ููุง ูููู ุงูุชูุงุนุจ ุจู
- ูุนูู ูู ุงูุฎูููุฉ

#### 2. Response Callback (ููุตู ุจู)
```
https://yoursite.vercel.app/api/paymob/callback
```

**ุงูุณุจุจ:**
- ูุญุณู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู
- ูุญูู ุงููุณุชุฎุฏู ูุตูุญุฉ ุงูุชุฃููุฏ ูุจุงุดุฑุฉ
- ูุนุฑุถ ุฑูู ุงูุทูุจ ููุฑุงู

---

## ๐ ุฎุทูุงุช ุงููุดุฑ ุนูู Vercel

### ุงูุฎุทูุฉ 1: ุชุซุจูุช Vercel CLI

```bash
npm install -g vercel
```

### ุงูุฎุทูุฉ 2: ุชุณุฌูู ุงูุฏุฎูู

```bash
vercel login
```

### ุงูุฎุทูุฉ 3: ุงููุดุฑ

```bash
# ูู ูุฌูุฏ ุงููุดุฑูุน
cd c:\Users\medor\Desktop\new-ecom

# ุงููุดุฑ
vercel
```

ุงุชุจุน ุงูุชุนูููุงุช:
- ุงุถุบุท Enter ููุจูู ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ
- ุณูุชู ุฑูุน ุงููุดุฑูุน
- ุณุชุญุตู ุนูู ุฑุงุจุท ูุซู: `https://new-ecom-xxx.vercel.app`

### ุงูุฎุทูุฉ 4: ุฅุถุงูุฉ Environment Variables

ูู Vercel Dashboard:
1. ุงุฐูุจ ุฅูู Project Settings
2. ุงุฎุชุฑ Environment Variables
3. ุฃุถู ุงููุชุบูุฑุงุช ูู `.env.local`:
   ```
   NEXT_PUBLIC_SUPABASE_URL=...
   NEXT_PUBLIC_SUPABASE_ANON_KEY=...
   SUPABASE_SERVICE_ROLE_KEY=...
   PAYMOB_API_KEY=...
   PAYMOB_INTEGRATION_ID=...
   PAYMOB_IFRAME_ID=...
   PAYMOB_HMAC_SECRET=...
   NEXT_PUBLIC_APP_URL=https://new-ecom-xxx.vercel.app
   ```

### ุงูุฎุทูุฉ 5: ุฅุนุงุฏุฉ ุงููุดุฑ

```bash
vercel --prod
```

### ุงูุฎุทูุฉ 6: ุชุญุฏูุซ Paymob Portal

ุงูุขู ุญุฏูุซ Callbacks ูู Paymob Portal:

**Processed Callback:**
```
https://new-ecom-xxx.vercel.app/api/webhooks/paymob
```

**Response Callback:**
```
https://new-ecom-xxx.vercel.app/api/paymob/callback
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ ุจุนุฏ ุงููุดุฑ

### 1. ุงูุชุญ ุงููููุน ุงูููุดูุฑ

```
https://new-ecom-xxx.vercel.app
```

### 2. ุงุฎุชุจุฑ ุนูููุฉ ุงูุดุฑุงุก

1. ุฃุถู ููุชุฌ ููุณูุฉ
2. ุงุฐูุจ ููู Checkout
3. ุงููุฃ ุจูุงูุงุช ุงูุดุญู
4. ุงุฎุชุฑ "Credit/Debit Card"
5. ุงุณุชุฎุฏู ุจุทุงูุฉ ุงูุงุฎุชุจุงุฑ: `4987654321098769`
6. ุฃููู ุงูุฏูุน

### 3. ุงููุชูุฌุฉ ุงููุชููุนุฉ

- โ ุงูุฏูุน ููุฌุญ ูู Paymob
- โ ูุชู ุชุญูููู ูุตูุญุฉ ุงูุชุฃููุฏ
- โ ุฑูู ุงูุทูุจ ูุธูุฑ
- โ ุญุงูุฉ ุงูุทูุจ: "confirmed"
- โ payment_status: "paid"

---

## ๐ ุงูุชุญูู ูู Callbacks

### ูู Paymob Portal

1. ุงุฐูุจ ุฅูู **Transactions**
2. ุงุจุญุซ ุนู ุขุฎุฑ ูุนุงููุฉ
3. ุงุถุบุท ุนูููุง
4. ุชุญูู ูู **Callback Status**

ูุฌุจ ุฃู ุชุฑู:
- โ Processed Callback: Success
- โ Response Callback: Success

### ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

```sql
SELECT 
  order_number,
  status,
  payment_status,
  paymob_transaction_id
FROM orders
ORDER BY created_at DESC
LIMIT 1;
```

ุงููุชูุฌุฉ ุงููุชููุนุฉ:
```
status: confirmed
payment_status: paid
paymob_transaction_id: 123456
```

---

## โ๏ธ ููุงุญุธุงุช ูุงูุฉ

> **๐ก ุงุณุชุฎุฏู ููุง ุงูู Callbacks**
> 
> - **Processed Callback:** ููููุซูููุฉ
> - **Response Callback:** ูุชุฌุฑุจุฉ ุงููุณุชุฎุฏู
> 
> ูุนุงู ูููุฑุงู ุฃูุถู ุชุฌุฑุจุฉ!

> **๐ HMAC Verification**
> 
> ููุง ุงูู Callbacks ูุชุญููุงู ูู HMAC ููุฃูุงู

> **โก ุงูุฃููููุฉ**
> 
> ุฅุฐุง ูุงู ุนููู ุงุฎุชูุงุฑ ูุงุญุฏ ููุท:
> - ุงุฎุชุฑ **Processed Callback** (ุฃูุซุฑ ููุซูููุฉ)

---

## ๐ ุงููุดุงูู ุงูุดุงุฆุนุฉ

### ุงููุดููุฉ: "Callback not received"

**ุงูุญู:**
1. ุชุฃูุฏ ูู ุฃู ุงูุฑุงุจุท ุตุญูุญ
2. ุชุฃูุฏ ูู ุฃู ุงูุณูุฑูุฑ ูุนูู
3. ุชุญูู ูู Logs ูู Vercel

### ุงููุดููุฉ: "Invalid HMAC"

**ุงูุญู:**
1. ุชุฃูุฏ ูู `PAYMOB_HMAC_SECRET` ูู Environment Variables
2. ุชุฃูุฏ ูู ุฃูู ูุทุงุจู Portal

---

**ุงูุขู ุฃูุช ุฌุงูุฒ ูููุดุฑ! ๐**

ุจุนุฏ ุงููุดุฑ ุนูู Vercelุ ุญุฏูุซ Paymob Portal ูุณุชุนูู ุฌููุน Callbacks ุจุดูู ุตุญูุญ.
